<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è‡ªå‹•åŒ–æ€è€ƒåˆ†æå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f0f4f8; }
    textarea, input[type="date"], input[type="text"], input[type="range"] { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 1em; }
    button { padding: 10px 20px; margin-top: 1em; font-size: 1em; }
    #output, #history, #moodChartContainer { margin-top: 2em; background: #fff; padding: 1em; border-radius: 10px; }
    #history { margin-top: 3em; }
    .entry { margin-bottom: 1.5em; border-bottom: 1px dashed #ccc; padding-bottom: 1em; }
    #moodValueDisplay { font-weight: bold; text-align: center; margin-bottom: 1em; }
    #loginStatus { margin-top: 1em; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ğŸ§  è‡ªå‹•åŒ–æ€è€ƒåˆ†æå™¨</h1>
  <button onclick="loginWithGoogle()">ğŸ” ä½¿ç”¨ Google ç™»å…¥</button>
  <div id="loginStatus"></div>
  <p>è«‹é¸æ“‡æ—¥æœŸèˆ‡è¼¸å…¥ä½ ä»Šå¤©çš„æƒ³æ³•ï¼š</p>
  <input type="date" id="inputDate" />
  <textarea id="inputThought" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»Šå¤©åœ¨å ±å‘Šæ™‚çµå·´äº†ï¼Œè¦ºå¾—å¤§å®¶è¦ºå¾—æˆ‘å¾ˆå·®..."></textarea>
  <button onclick="startVoiceInput()">ğŸ™ï¸ ä½¿ç”¨èªéŸ³è¼¸å…¥æƒ³æ³•</button>
  <p id="voiceStatus"></p>
  <label for="moodRange">ä»Šæ—¥å¿ƒæƒ…æº«åº¦è¨ˆï¼ˆ0-10ï¼‰ï¼š</label>
  <input type="range" id="moodRange" min="0" max="10" step="1" value="5" oninput="document.getElementById('moodValueDisplay').innerText = `å¿ƒæƒ…åˆ†æ•¸ï¼š${this.value}`">
  <div id="moodValueDisplay">å¿ƒæƒ…åˆ†æ•¸ï¼š5</div>
  <button onclick="analyzeThought()">åˆ†ææˆ‘çš„æƒ³æ³•</button>
  <button onclick="exportHistory()">ğŸ“ åŒ¯å‡ºæ–‡å­—ç´€éŒ„</button>
  <button onclick="exportExcel()">ğŸ“Š åŒ¯å‡º Excel</button>

  <div id="output"></div>

  <div id="history">
    <h2>ğŸ—‚ï¸ æ­·å²ç´€éŒ„</h2>
    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹æ­·å²ç´€éŒ„..." oninput="filterHistory()">
    <div id="historyEntries"></div>
  </div>

  <div id="moodChartContainer">
    <h2>ğŸ“ˆ å¿ƒæƒ…è®ŠåŒ–åœ–è¡¨</h2>
    <canvas id="moodChart"></canvas>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBxnh_QK6r-luS3yMOfEsv3LLZaW8GPrbU",
      authDomain: "cbt-thinking.firebaseapp.com",
      projectId: "cbt-thinking",
      storageBucket: "cbt-thinking.firebasestorage.app",
      messagingSenderId: "637682778759",
      appId: "1:637682778759:web:9c2b2360ad88573766ae22",
      measurementId: "G-WGHQVYETPD"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          document.getElementById("loginStatus").innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${result.user.displayName}`;
          loadHistory();
        })
        .catch((error) => {
          document.getElementById("loginStatus").innerText = `âŒ ç™»å…¥å¤±æ•—ï¼š${error.message}`;
        });
    }

    async function analyzeThought() {
      const thought = document.getElementById("inputThought").value;
      const mood = document.getElementById("moodRange").value;
      const date = document.getElementById("inputDate").value;
      const output = document.getElementById("output");
      output.innerText = "ğŸ¤” æ­£åœ¨åˆ†æä¸­...è«‹ç¨å€™...";

      try {
        const response = await fetch("https://cbt-analyzer.onrender.com/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ thought })
        });

        const data = await response.json();

        if (!data.reply) throw new Error("å›å‚³è³‡æ–™æ ¼å¼éŒ¯èª¤");

        const analysis = data.reply;
        output.innerHTML = `<h3>ğŸ§¾ åˆ†æçµæœ</h3><p>${analysis.replace(/\n/g, '<br>')}</p>`;

        const user = auth.currentUser;
        if (user) {
          await db.collection("thoughts").add({
            uid: user.uid,
            thought,
            mood,
            date,
            analysis,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          loadHistory();
        }
      } catch (error) {
        output.innerText = `âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
      }
    }

    async function loadHistory() {
      const user = auth.currentUser;
      if (!user) return;

      const snapshot = await db.collection("thoughts")
        .where("uid", "==", user.uid)
        .orderBy("date", "desc")
        .get();

      const historyContainer = document.getElementById("historyEntries");
      historyContainer.innerHTML = "";

      const dataForChart = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        dataForChart.push(data);
        const div = document.createElement("div");
        div.classList.add("entry");
        div.innerHTML = `
          <strong>${data.date}</strong><br>
          æƒ³æ³•ï¼š${data.thought}<br>
          å¿ƒæƒ…åˆ†æ•¸ï¼š${data.mood}<br>
          åˆ†æçµæœï¼š<br>${(data.analysis || "").replace(/\n/g, "<br>")}
        `;
        historyContainer.appendChild(div);
      });

      drawMoodChart(dataForChart);
    }

    let moodChart;
    function drawMoodChart(data) {
      const ctx = document.getElementById("moodChart").getContext("2d");
      const labels = data.map(entry => entry.date).reverse();
      const moods = data.map(entry => Number(entry.mood)).reverse();

      if (moodChart) moodChart.destroy();

      moodChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "å¿ƒæƒ…åˆ†æ•¸",
            data: moods,
            fill: false,
            borderColor: "rgb(75, 192, 192)",
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { min: 0, max: 10 }
          }
        }
      });
    }

    function startVoiceInput() {
      const status = document.getElementById("voiceStatus");
      const input = document.getElementById("inputThought");
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        status.innerText = "âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ã€‚è«‹æ”¹ç”¨ Chrome æˆ– Edgeã€‚";
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = "zh-TW";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      status.innerText = "ğŸ§ è†è½ä¸­...è«‹é–‹å§‹èªªè©±";
      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        status.innerText = "âœ… å·²å®ŒæˆèªéŸ³è¼¸å…¥ï¼";
      };
      recognition.onerror = function (event) {
        status.innerText = `âš ï¸ èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š${event.error}`;
      };
      recognition.onend = function () {
        if (status.innerText === "ğŸ§ è†è½ä¸­...è«‹é–‹å§‹èªªè©±") {
          status.innerText = "âš ï¸ æ²’æœ‰æ”¶åˆ°èªéŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
        }
      };
      recognition.start();
    }

    function filterHistory() {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      const entries = document.querySelectorAll("#historyEntries .entry");
      entries.forEach(entry => {
        entry.style.display = entry.innerText.toLowerCase().includes(keyword) ? "block" : "none";
      });
    }

async function exportHistory() {
  const user = auth.currentUser;
  if (!user) return alert("è«‹å…ˆç™»å…¥ï¼");
  
  const snapshot = await db.collection("thoughts")
    .where("uid", "==", user.uid)
    .orderBy("date", "desc")
    .get();

  let content = "ã€æˆ‘çš„è‡ªå‹•åŒ–æ€è€ƒç´€éŒ„ã€‘\n\n";
  snapshot.forEach(doc => {
    const data = doc.data();
    content += `ğŸ“… æ—¥æœŸï¼š${data.date}\n`;
    content += `ğŸ§  æƒ³æ³•ï¼š${data.thought}\n`;
    content += `ğŸ’¡ å¿ƒæƒ…åˆ†æ•¸ï¼š${data.mood}\n`;
    content += `ğŸ“‹ åˆ†æçµæœï¼š\n${data.analysis}\n`;
    content += `-------------------------\n`;
  });

  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "è‡ªå‹•åŒ–æ€è€ƒç´€éŒ„.txt";
  link.click();
}

async function exportExcel() {
  const user = auth.currentUser;
  if (!user) return alert("è«‹å…ˆç™»å…¥ï¼");

  const snapshot = await db.collection("thoughts")
    .where("uid", "==", user.uid)
    .orderBy("date", "desc")
    .get();

  const rows = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    rows.push({
      æ—¥æœŸ: data.date,
      æƒ³æ³•: data.thought,
      å¿ƒæƒ…åˆ†æ•¸: data.mood,
      åˆ†æçµæœ: data.analysis
    });
  });

  const worksheet = XLSX.utils.json_to_sheet(rows);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "æ€è€ƒç´€éŒ„");

  XLSX.writeFile(workbook, "è‡ªå‹•åŒ–æ€è€ƒç´€éŒ„.xlsx");
}

  </script>
</body>
</html>
