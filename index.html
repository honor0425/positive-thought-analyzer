<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è‡ªå‹•åŒ–æ€è€ƒåˆ†æå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f0f4f8; }
    textarea, input[type="date"], input[type="text"], input[type="range"] { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 1em; }
    button { padding: 10px 20px; margin-top: 1em; font-size: 1em; }
    #output, #history, #moodChartContainer { margin-top: 2em; background: #fff; padding: 1em; border-radius: 10px; }
    #history { margin-top: 3em; }
    .entry { margin-bottom: 1.5em; border-bottom: 1px dashed #ccc; padding-bottom: 1em; }
    #moodValueDisplay { font-weight: bold; text-align: center; margin-bottom: 1em; }
    #loginStatus { margin-top: 1em; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ğŸ§  è‡ªå‹•åŒ–æ€è€ƒåˆ†æå™¨</h1>
  <button onclick="loginWithGoogle()">ğŸ” ä½¿ç”¨ Google ç™»å…¥</button>
  <div id="loginStatus"></div>
  <p>è«‹é¸æ“‡æ—¥æœŸèˆ‡è¼¸å…¥ä½ ä»Šå¤©çš„æƒ³æ³•ï¼š</p>
  <input type="date" id="inputDate" />
  <textarea id="inputThought" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»Šå¤©åœ¨å ±å‘Šæ™‚çµå·´äº†ï¼Œè¦ºå¾—å¤§å®¶è¦ºå¾—æˆ‘å¾ˆå·®..."></textarea>
  <label for="moodRange">ä»Šæ—¥å¿ƒæƒ…æº«åº¦è¨ˆï¼ˆ0-10ï¼‰ï¼š</label>
  <input type="range" id="moodRange" min="0" max="10" step="1" value="5" oninput="document.getElementById('moodValueDisplay').innerText = `å¿ƒæƒ…åˆ†æ•¸ï¼š${this.value}`">
  <div id="moodValueDisplay">å¿ƒæƒ…åˆ†æ•¸ï¼š5</div>
  <button onclick="analyzeThought()">åˆ†ææˆ‘çš„æƒ³æ³•</button>
  <button onclick="exportHistory()">ğŸ“ åŒ¯å‡ºæ–‡å­—ç´€éŒ„</button>
  <button onclick="exportExcel()">ğŸ“Š åŒ¯å‡º Excel</button>

  <div id="output"></div>

  <div id="history">
    <h2>ğŸ—‚ï¸ æ­·å²ç´€éŒ„</h2>
    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹æ­·å²ç´€éŒ„..." oninput="filterHistory()">
    <div id="historyEntries"></div>
  </div>

  <div id="moodChartContainer">
    <h2>ğŸ“ˆ å¿ƒæƒ…è®ŠåŒ–åœ–è¡¨</h2>
    <canvas id="moodChart"></canvas>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBxnh_QK6r-luS3yMOfEsv3LLZaW8GPrbU",
      authDomain: "cbt-thinking.firebaseapp.com",
      projectId: "cbt-thinking",
      storageBucket: "cbt-thinking.appspot.com",
      messagingSenderId: "637682778759",
      appId: "1:637682778759:web:9c2b2360ad88573766ae22",
      measurementId: "G-WGHQVYETPD"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          document.getElementById("loginStatus").innerText = `ğŸ‘‹ æ­¡è¿ ${user.displayName}`;
          loadUserEntries(user.uid);
        })
        .catch((error) => {
          console.error("ç™»å…¥å¤±æ•—", error);
          document.getElementById("loginStatus").innerText = "âŒ ç™»å…¥å¤±æ•—";
        });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("loginStatus").innerText = `ğŸ‘‹ æ­¡è¿ ${user.displayName}`;
        loadUserEntries(user.uid);
      }
    });

    let allEntries = [];
    let moodChart;

    function analyzeThought() {
      const date = document.getElementById("inputDate").value;
      const thought = document.getElementById("inputThought").value;
      const mood = document.getElementById("moodRange").value;
      const outputDiv = document.getElementById("output");

      let mockResult = `
        <h2>åˆ†æçµæœ</h2>
        <p><strong>äº‹ä»¶ï¼š</strong>ä½ åœ¨å ±å‘Šæ™‚çµå·´äº†</p>
        <p><strong>æƒ…ç·’ï¼š</strong>ç¾æ„§ã€ä¸å®‰</p>
        <p><strong>è‡ªå‹•åŒ–æ€è€ƒï¼š</strong>å¤§å®¶ä¸€å®šè¦ºå¾—æˆ‘å¾ˆæ²’ç”¨</p>
        <p><strong>èªçŸ¥è¬¬èª¤ï¼š</strong>è®€å¿ƒè¡“ã€ç½é›£åŒ–</p>
        <p><strong>å»ºè­°æ€§çš„åæ€ï¼š</strong>å³ä½¿æˆ‘è¡¨ç¾ä¸å®Œç¾ï¼Œé€™ä¹Ÿä¸ä»£è¡¨æˆ‘æ²’ç”¨ï¼Œåˆ¥äººå¯èƒ½ç†è§£æˆ‘åªæ˜¯ç·Šå¼µã€‚</p>
        <p><strong>æ›¿ä»£æ€§æ€è€ƒï¼š</strong>æˆ‘å¯ä»¥ä¸‹æ¬¡æå‰ç·´ç¿’å ±å‘Šï¼Œè®“è‡ªå·±æ›´æœ‰ä¿¡å¿ƒï¼Œé€™æ¬¡çš„ç¶“é©—è®“æˆ‘çŸ¥é“è¦æ›´æº–å‚™ã€‚</p>
      `;

      const time = new Date().toLocaleTimeString();
      const fullDate = date ? date : new Date().toLocaleDateString();
      const fullTimestamp = `${fullDate} ${time}`;

      outputDiv.innerHTML = mockResult;

      const entry = { date: fullTimestamp, thought, mood: parseInt(mood), html: mockResult };
      allEntries.push(entry);
      displayHistory();
      updateMoodChart();

      document.getElementById("inputThought").value = "";

      if (auth.currentUser) {
        db.collection("entries").add({
          uid: auth.currentUser.uid,
          date: fullTimestamp,
          thought: thought,
          mood: parseInt(mood),
          result: mockResult
        });
      }
    }

    function loadUserEntries(uid) {
      db.collection("entries")
        .where("uid", "==", uid)
        .orderBy("date")
        .get()
        .then(snapshot => {
          allEntries = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
              date: data.date,
              thought: data.thought,
              mood: data.mood,
              html: data.result
            };
          });
          displayHistory();
          updateMoodChart();
        });
    }

    function displayHistory() {
      const container = document.getElementById("historyEntries");
      container.innerHTML = "";
      allEntries.forEach(entry => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `<p><strong>${entry.date}</strong></p>${entry.html}`;
        container.appendChild(div);
      });
    }

    function filterHistory() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const container = document.getElementById("historyEntries");
      container.innerHTML = "";

      allEntries
        .filter(entry =>
          entry.thought.toLowerCase().includes(searchTerm) ||
          entry.html.toLowerCase().includes(searchTerm)
        )
        .forEach(entry => {
          const div = document.createElement("div");
          div.className = "entry";
          div.innerHTML = `<p><strong>${entry.date}</strong></p>${entry.html}`;
          container.appendChild(div);
        });
    }

    function exportHistory() {
      let content = "";
      allEntries.forEach(entry => {
        content += `ã€${entry.date}ã€‘\næƒ³æ³•ï¼š${entry.thought}\nå¿ƒæƒ…åˆ†æ•¸ï¼š${entry.mood}\n\n`;
      });

      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cbt_æ­·å²ç´€éŒ„.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportExcel() {
      let csvContent = "æ—¥æœŸ,æƒ³æ³•,å¿ƒæƒ…åˆ†æ•¸\n";
      allEntries.forEach(entry => {
        const row = `"${entry.date}","${entry.thought.replace(/"/g, '""')}","${entry.mood}"\n`;
        csvContent += row;
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cbt_æ­·å²ç´€éŒ„.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateMoodChart() {
      const ctx = document.getElementById("moodChart").getContext("2d");
      const labels = allEntries.map(entry => entry.date);
      const data = allEntries.map(entry => entry.mood);

      if (moodChart) {
        moodChart.destroy();
      }

      moodChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "å¿ƒæƒ…åˆ†æ•¸",
            data: data,
            fill: false,
            borderColor: "#3e95cd",
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              suggestedMin: 0,
              suggestedMax: 10
            }
          }
        }
      });
    }
  </script>
</body>
</html>